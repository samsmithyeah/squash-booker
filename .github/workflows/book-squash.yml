name: Book Squash Court

on:
  schedule:
    # Run every Tuesday at 10:02 PM UK time (22:02 UTC during GMT, 21:02 UTC during BST)
    # Using 22:02 UTC - this is 10:02 PM GMT / 11:02 PM BST
    - cron: "2 22 * * 2"
  workflow_dispatch:
    inputs:
      day:
        description: "Day to book"
        required: false
        type: choice
        default: "Mon"
        options:
          - Mon
          - Tue
          - Wed
          - Thu
          - Fri
          - Sat
          - Sun
      time1:
        description: "First time slot (weekend: 08:00-16:40, weekday: 07:00-21:00)"
        required: false
        type: choice
        default: "19:40"
        options:
          - "07:00"
          - "07:40"
          - "08:00"
          - "08:20"
          - "08:40"
          - "09:00"
          - "09:20"
          - "09:40"
          - "10:00"
          - "10:20"
          - "10:40"
          - "11:00"
          - "11:20"
          - "11:40"
          - "12:00"
          - "12:20"
          - "12:40"
          - "13:00"
          - "13:20"
          - "13:40"
          - "14:00"
          - "14:20"
          - "14:40"
          - "15:00"
          - "15:20"
          - "15:40"
          - "16:00"
          - "16:20"
          - "16:40"
          - "17:00"
          - "17:20"
          - "17:40"
          - "18:20"
          - "19:00"
          - "19:40"
          - "20:20"
          - "21:00"
      time2:
        description: "Second time slot (optional)"
        required: false
        type: choice
        default: "20:20"
        options:
          - none
          - "07:00"
          - "07:40"
          - "08:00"
          - "08:20"
          - "08:40"
          - "09:00"
          - "09:20"
          - "09:40"
          - "10:00"
          - "10:20"
          - "10:40"
          - "11:00"
          - "11:20"
          - "11:40"
          - "12:00"
          - "12:20"
          - "12:40"
          - "13:00"
          - "13:20"
          - "13:40"
          - "14:00"
          - "14:20"
          - "14:40"
          - "15:00"
          - "15:20"
          - "15:40"
          - "16:00"
          - "16:20"
          - "16:40"
          - "17:00"
          - "17:20"
          - "17:40"
          - "18:20"
          - "19:00"
          - "19:40"
          - "20:20"
          - "21:00"

jobs:
  book-court:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps --only-shell chromium

      - name: Run booking script
        env:
          BOOKING_DAY: ${{ github.event.inputs.day }}
          BOOKING_TIME1: ${{ github.event.inputs.time1 }}
          BOOKING_TIME2: ${{ github.event.inputs.time2 }}
          BOOKING_URL: ${{ secrets.BOOKING_URL }}
          USERNAME: ${{ secrets.USERNAME }}
          PASSWORD: ${{ secrets.PASSWORD }}
          CVV: ${{ secrets.CVV }}
          HEADLESS: true
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_WHATSAPP_FROM: ${{ secrets.TWILIO_WHATSAPP_FROM }}
          TWILIO_WHATSAPP_TO: ${{ secrets.TWILIO_WHATSAPP_TO }}
        run: npm run book

      - name: Upload Playwright artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-artifacts
          path: artifacts/
          retention-days: 30
